generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model bus_stops {
  stop_id     Int           @id @default(autoincrement())
  latitude    Decimal?      @db.Decimal(11, 8)
  longitude   Decimal?      @db.Decimal(11, 8)
  address     String?       @db.VarChar(255)
  is_active   Boolean?      @default(true)
  students    students[]
  route_stops route_stops[]
}

model buses {
  bus_id                Int                 @id @default(autoincrement())
  bus_number            String              @unique(map: "bus_number") @db.VarChar(50)
  license_plate         String              @unique(map: "license_plate") @db.VarChar(50)
  capacity              Int?
  model                 String?             @db.VarChar(100)
  year                  Int?
  status                String?             @db.VarChar(20)
  last_maintenance_date DateTime?           @db.Date
  route_assignments     route_assignments[]
  routes                routes[]
}

model route_stops {
  route_stop_id Int @id @default(autoincrement())
  route_id      Int
  stop_id       Int
  stop_order    Int

  route routes    @relation(fields: [route_id], references: [route_id], onDelete: Cascade)
  stop  bus_stops @relation(fields: [stop_id], references: [stop_id], onDelete: Cascade)

  @@unique([route_id, stop_id]) // mỗi trạm chỉ xuất hiện 1 lần trong 1 tuyến
  @@unique([route_id, stop_order]) // thứ tự trạm duy nhất trong mỗi tuyến
  @@map("route_stops") // ánh xạ đúng tên bảng trong DB
}

model route_assignments {
  assignment_id   Int              @id @default(autoincrement())
  route_id        Int
  driver_id       Int
  bus_id          Int
  assignment_date DateTime         @db.Date
  is_active       Boolean?         @default(true)
  created_at      DateTime?        @default(now()) @db.Timestamp(0)
  routes          routes           @relation(fields: [route_id], references: [route_id], onDelete: Cascade, onUpdate: NoAction, map: "route_assignments_ibfk_1")
  users           users            @relation(fields: [driver_id], references: [user_id], onUpdate: NoAction, map: "route_assignments_ibfk_2")
  buses           buses            @relation(fields: [bus_id], references: [bus_id], onUpdate: NoAction, map: "route_assignments_ibfk_3")
  student_events  student_events[]

  @@unique([route_id, driver_id, assignment_date], map: "uniq_route_driver_date")
  @@index([bus_id], map: "idx_route_assignments_bus_id")
  @@index([driver_id], map: "idx_route_assignments_driver_id")
  @@index([route_id], map: "idx_route_assignments_route_id")
}

model routes {
  route_id          Int                 @id @default(autoincrement())
  route_type        String?             @db.VarChar(20)
  bus_id            Int?
  start_time        String?             @db.VarChar(8)
  is_active         Boolean?            @default(true)
  created_at        DateTime?           @default(now()) @db.Timestamp(0)
  updated_at        DateTime?           @default(now()) @db.Timestamp(0)
  route_assignments route_assignments[]
  buses             buses?              @relation(fields: [bus_id], references: [bus_id], onUpdate: NoAction, map: "routes_ibfk_1")
  route_stops       route_stops[]

  @@index([bus_id], map: "idx_routes_bus_id")
}

model notifications {
  notification_id   Int             @id @default(autoincrement())
  user_id           Int
  notification_type String?         @db.VarChar(20)
  title             String          @db.VarChar(255)
  message           String?         @db.Text
  event_id          Int?
  is_read           Boolean?        @default(false)
  created_at        DateTime?       @default(now()) @db.Timestamp(0)
  users             users           @relation(fields: [user_id], references: [user_id], onDelete: Cascade, onUpdate: NoAction, map: "notifications_ibfk_1")
  student_events    student_events? @relation(fields: [event_id], references: [event_id], onUpdate: NoAction, map: "notifications_ibfk_2")

  @@index([event_id], map: "idx_notifications_event_id")
  @@index([user_id], map: "idx_notifications_user_id")
}

model student_events {
  event_id            Int                @id @default(autoincrement())
  student_id          Int
  route_assignment_id Int?
  event_type          String             @db.VarChar(20)
  event_time          DateTime           @db.Timestamp(0)
  notes               String?            @db.Text
  notifications       notifications[]
  students            students           @relation(fields: [student_id], references: [student_id], onDelete: Cascade, onUpdate: NoAction, map: "student_events_ibfk_1")
  route_assignments   route_assignments? @relation(fields: [route_assignment_id], references: [assignment_id], onUpdate: NoAction, map: "student_events_ibfk_2")

  @@index([route_assignment_id], map: "idx_student_events_assignment_id")
  @@index([student_id], map: "idx_student_events_student_id")
}

model students {
  student_id        Int              @id @default(autoincrement())
  parent_id         Int?
  full_name         String           @db.VarChar(255)
  profile_photo_url String?          @db.VarChar(255)
  is_active         Boolean?         @default(true)
  created_at        DateTime?        @default(now()) @db.Timestamp(0)
  stop_id           Int?
  student_events    student_events[]
  users             users?           @relation(fields: [parent_id], references: [user_id], onUpdate: NoAction, map: "students_ibfk_1")
  bus_stops         bus_stops?       @relation(fields: [stop_id], references: [stop_id], onUpdate: NoAction, map: "students_ibfk_2")

  @@index([parent_id], map: "idx_students_parent_id")
  @@index([stop_id], map: "idx_students_stop_id")
}

model users {
  user_id           Int                 @id @default(autoincrement())
  email             String              @unique(map: "email") @db.VarChar(255)
  password          String              @db.VarChar(255)
  full_name         String?             @db.VarChar(255)
  phone_number      String?             @db.VarChar(20)
  address           String?             @db.VarChar(255)
  role              String              @db.VarChar(20)
  is_active         Boolean?            @default(true)
  created_at        DateTime?           @default(now()) @db.Timestamp(0)
  updated_at        DateTime?           @default(now()) @db.Timestamp(0)
  chats1            chat[]              @relation("chatUser1")
  chats2            chat[]              @relation("chatUser2")
  sentMessages      chatMessage[]       @relation("sentMessages")
  notifications     notifications[]
  route_assignments route_assignments[]
  students          students[]
}

model chat {
  chat_id    Int           @id @default(autoincrement())
  user1_id   Int
  user2_id   Int
  created_at DateTime      @default(now())
  updated_at DateTime      @default(now()) @updatedAt
  user1      users         @relation("chatUser1", fields: [user1_id], references: [user_id])
  user2      users         @relation("chatUser2", fields: [user2_id], references: [user_id])
  messages   chatMessage[]

  @@unique([user1_id, user2_id])
  @@index([user2_id], map: "chat_user2_id_fkey")
}

model chatMessage {
  message_id   Int      @id @default(autoincrement())
  chat_id      Int
  sender_id    Int
  message      String
  message_type String   @default("text")
  is_read      Boolean  @default(false)
  created_at   DateTime @default(now())
  chat         chat     @relation(fields: [chat_id], references: [chat_id])
  sender       users    @relation("sentMessages", fields: [sender_id], references: [user_id])

  @@index([chat_id], map: "chatMessage_chat_id_fkey")
  @@index([sender_id], map: "chatMessage_sender_id_fkey")
}
