generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model users {
  user_id      Int       @id @default(autoincrement())
  email        String    @unique(map: "email") @db.VarChar(255)
  password     String    @db.VarChar(255)
  full_name    String?   @db.VarChar(255)
  phone_number String?   @db.VarChar(20)
  address      String?   @db.VarChar(255)
  role         String    @db.VarChar(20)
  is_active    Boolean?  @default(true)
  created_at   DateTime? @default(now()) @db.Timestamp(0)
  updated_at   DateTime? @default(now()) @db.Timestamp(0)

  notifications     notifications[]
  route_assignments route_assignments[]
  students          students[]
}

model buses {
  bus_id                Int                 @id @default(autoincrement())
  bus_number            String              @unique(map: "bus_number") @db.VarChar(50)
  license_plate         String              @unique(map: "license_plate") @db.VarChar(50)
  capacity              Int?
  model                 String?             @db.VarChar(100)
  year                  Int?
  status                String?             @db.VarChar(20)
  last_maintenance_date DateTime?           @db.Date
  route_assignments     route_assignments[]
}

model bus_stops {
  stop_id   Int      @id @default(autoincrement())
  latitude  Decimal? @db.Decimal(11, 8)
  longitude Decimal? @db.Decimal(11, 8)
  address   String?  @db.VarChar(255)
  is_active Boolean? @default(true)

  route_stops route_stops[]
}

model routes {
  route_id       Int       @id @default(autoincrement())
  route_type     String?   @db.VarChar(20)
  start_time     String?   @db.VarChar(8)
  is_active      Boolean?  @default(true)
  created_at     DateTime? @default(now()) @db.Timestamp(0)
  updated_at     DateTime? @default(now()) @db.Timestamp(0)
  generated_from Int?      @default(-1)

  route_assignments route_assignments[]
  route_stops       route_stops[]
}

model route_assignments {
  assignment_id Int       @id @default(autoincrement())
  route_id      Int
  driver_id     Int
  bus_id        Int
  is_active     Boolean?  @default(true)
  created_at    DateTime? @default(now()) @db.Timestamp(0)

  routes routes @relation(fields: [route_id], references: [route_id], onDelete: Cascade)

  users users @relation(fields: [driver_id], references: [user_id], onUpdate: NoAction)

  buses buses @relation(fields: [bus_id], references: [bus_id], onUpdate: NoAction)

  student_events student_events[]

  @@index([bus_id])
  @@index([driver_id])
  @@index([route_id])
}

model route_stops {
  route_stop_id Int @id @default(autoincrement())
  route_id      Int
  stop_id       Int
  stop_order    Int

  route routes @relation(fields: [route_id], references: [route_id], onDelete: Cascade)

  stop bus_stops @relation(fields: [stop_id], references: [stop_id], onDelete: Cascade)

  students route_stop_students[]

  @@unique([route_id, stop_id])
  @@unique([route_id, stop_order])
  @@map("route_stops")
}

model students {
  student_id        Int       @id @default(autoincrement())
  parent_id         Int?
  full_name         String    @db.VarChar(255)
  profile_photo_url String?   @db.VarChar(255)
  is_active         Boolean?  @default(true)
  created_at        DateTime? @default(now()) @db.Timestamp(0)

  users users? @relation(fields: [parent_id], references: [user_id], onUpdate: NoAction)

  route_stops    route_stop_students[]
  student_events student_events[]

  @@index([parent_id])
}

model student_events {
  event_id            Int                @id @default(autoincrement())
  student_id          Int
  route_assignment_id Int?
  event_type          String             @db.VarChar(20)
  event_time          DateTime           @default(now()) @db.Timestamp(0)
  notes               String?            @db.Text
  notifications       notifications[]
  students            students           @relation(fields: [student_id], references: [student_id], onDelete: Cascade, onUpdate: NoAction, map: "student_events_ibfk_1")
  route_assignments   route_assignments? @relation(fields: [route_assignment_id], references: [assignment_id], onUpdate: NoAction, map: "student_events_ibfk_2")

  @@index([route_assignment_id], map: "idx_student_events_assignment_id")
  @@index([student_id], map: "idx_student_events_student_id")
}

model route_stop_students {
  id            Int @id @default(autoincrement())
  route_stop_id Int
  student_id    Int

  route_stop route_stops @relation(fields: [route_stop_id], references: [route_stop_id], onDelete: Cascade)
  student    students    @relation(fields: [student_id], references: [student_id], onDelete: Cascade)

  @@unique([route_stop_id, student_id])
}

model notifications {
  notification_id   Int       @id @default(autoincrement())
  user_id           Int
  notification_type String?   @db.VarChar(20)
  title             String    @db.VarChar(255)
  message           String?   @db.Text
  event_id          Int?
  is_read           Boolean?  @default(false)
  created_at        DateTime? @default(now()) @db.Timestamp(0)

  users          users           @relation(fields: [user_id], references: [user_id], onDelete: Cascade, onUpdate: NoAction, map: "notifications_ibfk_1")
  student_events student_events? @relation(fields: [event_id], references: [event_id], onUpdate: NoAction, map: "notifications_ibfk_2")

  @@index([event_id], map: "idx_notifications_event_id")
  @@index([user_id], map: "idx_notifications_user_id")
}
